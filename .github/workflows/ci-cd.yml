name: CI/CD Pipeline

on:
  # è‡ªåŠ¨è§¦å‘ï¼šæ¨é€åˆ°ä¸»åˆ†æ”¯æˆ–PR
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_build_all:
        description: "å¼ºåˆ¶æ„å»ºæ‰€æœ‰åŒ…"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  # æ£€æµ‹å˜æ›´å¹¶æ„å»º
  build:
    runs-on: ubuntu-latest
    outputs:
      changed-apps: ${{ steps.detect-changes.outputs.changed-apps }}
      has-changes: ${{ steps.detect-changes.outputs.has-changes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: æ£€æµ‹å˜æ›´çš„åº”ç”¨
        id: detect-changes
        run: |
          echo "æ£€æµ‹ apps ç›®å½•ä¸‹çš„å˜æ›´..."

          # è·å–æ‰€æœ‰appsç›®å½•ä¸‹çš„åº”ç”¨
          APPS=$(ls -d apps/*/ 2>/dev/null | sed 's|apps/||g' | sed 's|/||g' | tr '\n' ' ')
          echo "å‘ç°çš„åº”ç”¨: $APPS"

          CHANGED_APPS=""
          HAS_CHANGES="false"

          if [ "${{ github.event.inputs.force_build_all }}" == "true" ]; then
            echo "å¼ºåˆ¶æ„å»ºæ‰€æœ‰åº”ç”¨"
            CHANGED_APPS="$APPS"
            HAS_CHANGES="true"
          else
            # æ£€æµ‹æ¯ä¸ªåº”ç”¨æ˜¯å¦æœ‰å˜æ›´
            for app in $APPS; do
              echo "æ£€æŸ¥ $app çš„å˜æ›´..."
              
              # æ£€æŸ¥åº”ç”¨æœ¬èº«çš„å˜æ›´
              APP_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep "^apps/$app/" || echo "")
              # æ£€æŸ¥ui-componentsçš„å˜æ›´ï¼ˆå½±å“æ‰€æœ‰åº”ç”¨ï¼‰
              UI_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep "^packages/ui-components/" || echo "")
              
              if [ -n "$APP_CHANGED" ] || [ -n "$UI_CHANGED" ]; then
                echo "âœ… $app æœ‰å˜æ›´"
                CHANGED_APPS="$CHANGED_APPS $app"
                HAS_CHANGES="true"
              else
                echo "â­ï¸  $app æ— å˜æ›´"
              fi
            done
          fi

          # æ¸…ç†ç©ºæ ¼
          CHANGED_APPS=$(echo $CHANGED_APPS | xargs)

          echo "å˜æ›´çš„åº”ç”¨: $CHANGED_APPS"
          echo "changed-apps=$CHANGED_APPS" >> $GITHUB_OUTPUT
          echo "has-changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

      - name: æ„å»ºå˜æ›´çš„åº”ç”¨
        if: steps.detect-changes.outputs.has-changes == 'true'
        run: |
          CHANGED_APPS="${{ steps.detect-changes.outputs.changed-apps }}"
          echo "å¼€å§‹æ„å»ºåº”ç”¨: $CHANGED_APPS"

          for app in $CHANGED_APPS; do
            echo "ğŸ”¨ æ„å»º $app..."
            if [ -f "apps/$app/package.json" ]; then
              # è·å–package.jsonä¸­çš„nameå­—æ®µä½œä¸ºè¿‡æ»¤å™¨
              PACKAGE_NAME=$(cat apps/$app/package.json | grep '"name"' | head -1 | sed 's/.*"name": *"\([^"]*\)".*/\1/')
              echo "åŒ…å: $PACKAGE_NAME"
              pnpm turbo build --filter="$PACKAGE_NAME"
            else
              echo "âŒ apps/$app/package.json ä¸å­˜åœ¨"
            fi
          done

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: |
          steps.detect-changes.outputs.has-changes == 'true' &&
          github.ref == 'refs/heads/master'
        run: |
          CHANGED_APPS="${{ steps.detect-changes.outputs.changed-apps }}"
          echo "ä¸Šä¼ æ„å»ºäº§ç‰©..."

          for app in $CHANGED_APPS; do
            if [ -d "apps/$app/dist" ]; then
              echo "ğŸ“¦ æ‰“åŒ… $app çš„æ„å»ºäº§ç‰©"
              tar -czf "$app-dist.tar.gz" -C "apps/$app/dist" .
              echo "äº§ç‰©å¤§å°: $(du -h $app-dist.tar.gz | cut -f1)"
            else
              echo "âš ï¸  apps/$app/dist ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          done

      - name: ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©ä¸ºartifacts
        if: |
          steps.detect-changes.outputs.has-changes == 'true' &&
          github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: "*-dist.tar.gz"
          retention-days: 1

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/master' &&
      needs.build.outputs.has-changes == 'true'

    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: è®¾ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: éƒ¨ç½²æ‰€æœ‰å˜æ›´çš„åº”ç”¨
        env:
          DEPLOY_BASE_PATH: ${{ secrets.DEPLOY_BASE_PATH || '/var/www' }}
        run: |
          CHANGED_APPS="${{ needs.build.outputs.changed-apps }}"
          echo "éœ€è¦éƒ¨ç½²çš„åº”ç”¨: $CHANGED_APPS"
          echo "åŸºç¡€éƒ¨ç½²è·¯å¾„: $DEPLOY_BASE_PATH"
          echo "å¯ç”¨çš„æ„å»ºäº§ç‰©:"
          ls -la ./artifacts/

          # éå†æ¯ä¸ªéœ€è¦éƒ¨ç½²çš„åº”ç”¨
          for APP_NAME in $CHANGED_APPS; do
            echo ""
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åº”ç”¨: $APP_NAME"
            
            # æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
            if [ ! -f "./artifacts/${APP_NAME}-dist.tar.gz" ]; then
              echo "âŒ æœªæ‰¾åˆ° $APP_NAME çš„æ„å»ºäº§ç‰©ï¼Œè·³è¿‡"
              continue
            fi
            
            echo "âœ… æ‰¾åˆ°æ„å»ºäº§ç‰©: ${APP_NAME}-dist.tar.gz"
            echo "æ–‡ä»¶å¤§å°: $(du -h ./artifacts/${APP_NAME}-dist.tar.gz | cut -f1)"
            
            # åŠ¨æ€è®¡ç®—éƒ¨ç½²è·¯å¾„
            DEPLOY_PATH="${DEPLOY_BASE_PATH}/${APP_NAME}"
            echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
            
            # ä¸Šä¼ éƒ¨ç½²åŒ…
            echo "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°æœåŠ¡å™¨..."
            scp -o StrictHostKeyChecking=no ./artifacts/${APP_NAME}-dist.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            echo "ğŸ“‹ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << EOF
              set -e
              
              # è®¾ç½®è¯­è¨€ç¯å¢ƒé¿å…è­¦å‘Š
              export LC_ALL=C
              export LANG=C
              
              APP_NAME="${APP_NAME}"
              DEPLOY_PATH="${DEPLOY_PATH}"
              
              echo "å¼€å§‹éƒ¨ç½²åº”ç”¨: \$APP_NAME"
              echo "ç›®æ ‡è·¯å¾„: \$DEPLOY_PATH"
              
              # åˆ›å»ºå¤‡ä»½
              if [ -d "\$DEPLOY_PATH" ]; then
                echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½..."
                cp -r "\$DEPLOY_PATH" "\$DEPLOY_PATH.backup.\$(date +%Y%m%d_%H%M%S)"
                
                # åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
                cd \$(dirname "\$DEPLOY_PATH")
                ls -t \${APP_NAME}.backup.* 2>/dev/null | tail -n +6 | xargs rm -rf 2>/dev/null || true
              fi
              
              # åˆ›å»ºéƒ¨ç½²ç›®å½•
              mkdir -p "\$DEPLOY_PATH"
              
              # æ¸…ç†æ—§æ–‡ä»¶å¹¶è§£å‹æ–°æ–‡ä»¶
              echo "ğŸ—‘ï¸  æ¸…ç†æ—§æ–‡ä»¶..."
              rm -rf "\$DEPLOY_PATH"/*
              
              echo "ğŸ“‚ è§£å‹æ–°æ–‡ä»¶..."
              tar -xzf /tmp/\${APP_NAME}-dist.tar.gz -C "\$DEPLOY_PATH"
              
              # è®¾ç½®æ­£ç¡®çš„æƒé™
              echo "ğŸ”§ è®¾ç½®æ–‡ä»¶æƒé™..."
              if id "nginx" >/dev/null 2>&1; then
                chown -R nginx:nginx "\$DEPLOY_PATH"
                echo "è®¾ç½®æ‰€æœ‰è€…ä¸º: nginx:nginx"
              elif id "www-data" >/dev/null 2>&1; then
                chown -R www-data:www-data "\$DEPLOY_PATH"
                echo "è®¾ç½®æ‰€æœ‰è€…ä¸º: www-data:www-data"
              else
                chown -R root:root "\$DEPLOY_PATH"
                echo "è®¾ç½®æ‰€æœ‰è€…ä¸º: root:root"
              fi
              
              # è®¾ç½®ç›®å½•å’Œæ–‡ä»¶æƒé™
              find "\$DEPLOY_PATH" -type d -exec chmod 755 {} \;
              find "\$DEPLOY_PATH" -type f -exec chmod 644 {} \;
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f /tmp/\${APP_NAME}-dist.tar.gz
              
              echo "âœ… \$APP_NAME éƒ¨ç½²å®Œæˆï¼"
              echo "ğŸ“ éƒ¨ç½²è·¯å¾„: \$DEPLOY_PATH"
              echo "ğŸ“Š æ–‡ä»¶æ•°é‡: \$(find "\$DEPLOY_PATH" -type f | wc -l)"
              
              # éªŒè¯å…³é”®æ–‡ä»¶
              if [ -f "\$DEPLOY_PATH/index.html" ]; then
                echo "âœ… index.html å­˜åœ¨ (\$(du -h "\$DEPLOY_PATH/index.html" | cut -f1))"
              else
                echo "âš ï¸  index.html ä¸å­˜åœ¨"
              fi
              
              if [ -d "\$DEPLOY_PATH/assets" ]; then
                echo "âœ… assets ç›®å½•å­˜åœ¨ (\$(find "\$DEPLOY_PATH/assets" -type f | wc -l) ä¸ªæ–‡ä»¶)"
              else
                echo "âš ï¸  assets ç›®å½•ä¸å­˜åœ¨"
              fi
              
              echo "â° éƒ¨ç½²æ—¶é—´: \$(date)"
          EOF
            
            echo "ğŸ‰ $APP_NAME éƒ¨ç½²æˆåŠŸ!"
          done

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        env:
          DEPLOY_BASE_PATH: ${{ secrets.DEPLOY_BASE_PATH || '/var/www' }}
        run: |
          CHANGED_APPS="${{ needs.build.outputs.changed-apps }}"
          echo ""
          echo "ğŸŠ æ‰€æœ‰åº”ç”¨éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“‹ å·²éƒ¨ç½²çš„åº”ç”¨: $CHANGED_APPS"
          echo "ğŸŒ æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          echo "ğŸ“ åŸºç¡€è·¯å¾„: $DEPLOY_BASE_PATH"
          echo "â° å®Œæˆæ—¶é—´: $(date)"
          echo ""
          echo "ğŸ”— åº”ç”¨è®¿é—®åœ°å€:"
          for app in $CHANGED_APPS; do
            echo "  - $app: http://${{ secrets.SERVER_HOST }}/$app"
          done
