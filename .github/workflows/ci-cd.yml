name: CI/CD Pipeline

on:
  # è‡ªåŠ¨è§¦å‘ï¼šæ¨é€åˆ°ä¸»åˆ†æ”¯æˆ–PR
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_build_all:
        description: 'å¼ºåˆ¶æ„å»ºæ‰€æœ‰åŒ…'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  # æ£€æµ‹å˜æ›´å¹¶æ„å»º
  build:
    runs-on: ubuntu-latest
    outputs:
      admin-system-changed: ${{ steps.changes.outputs.admin-system }}
      ui-components-changed: ${{ steps.changes.outputs.ui-components }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            admin-system:
              - 'apps/admin-system/**'
              - 'packages/ui-components/**'
            ui-components:
              - 'packages/ui-components/**'

      - name: æ˜¾ç¤ºå˜æ›´æ£€æµ‹ç»“æœ
        run: |
          echo "Admin System Changed: ${{ steps.changes.outputs.admin-system }}"
          echo "UI Components Changed: ${{ steps.changes.outputs.ui-components }}"
          echo "Force Build All: ${{ github.event.inputs.force_build_all }}"

      - name: è¿è¡ŒTurboæ„å»º (ä»…å˜æ›´çš„åŒ…)
        if: |
          github.event.inputs.force_build_all != 'true' && 
          (steps.changes.outputs.admin-system == 'true' || steps.changes.outputs.ui-components == 'true')
        run: |
          if [ "${{ steps.changes.outputs.admin-system }}" == "true" ]; then
            echo "æ„å»º admin-system (åŒ…å«ä¾èµ–)"
            pnpm turbo build --filter=@monorepo-project/admin-system
          elif [ "${{ steps.changes.outputs.ui-components }}" == "true" ]; then
            echo "æ„å»º ui-components"
            pnpm turbo build --filter=@monorepo-project/ui-components
          fi

      - name: è¿è¡ŒTurboæ„å»º (æ‰€æœ‰åŒ…)
        if: github.event.inputs.force_build_all == 'true'
        run: |
          echo "å¼ºåˆ¶æ„å»ºæ‰€æœ‰åŒ…"
          pnpm turbo build

      - name: ä¸Šä¼  admin-system æ„å»ºäº§ç‰©
        if: |
          (steps.changes.outputs.admin-system == 'true' || github.event.inputs.force_build_all == 'true') &&
          github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: admin-system-dist
          path: apps/admin-system/dist/
          retention-days: 1

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/master' &&
      (needs.build.outputs.admin-system-changed == 'true' || github.event.inputs.force_build_all == 'true')
    
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: admin-system-dist
          path: ./dist

      - name: è®¾ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: åˆ›å»ºéƒ¨ç½²åŒ…
        run: |
          tar -czf admin-system.tar.gz -C ./dist .
          echo "éƒ¨ç½²åŒ…å¤§å°: $(du -h admin-system.tar.gz | cut -f1)"

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          # ä¸Šä¼ éƒ¨ç½²åŒ…
          scp -o StrictHostKeyChecking=no admin-system.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
          
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            # åˆ›å»ºå¤‡ä»½
            if [ -d "${{ secrets.DEPLOY_PATH }}" ]; then
              echo "åˆ›å»ºå¤‡ä»½..."
              sudo cp -r ${{ secrets.DEPLOY_PATH }} ${{ secrets.DEPLOY_PATH }}.backup.$(date +%Y%m%d_%H%M%S)
              
              # åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
              cd $(dirname ${{ secrets.DEPLOY_PATH }})
              sudo ls -t *.backup.* 2>/dev/null | tail -n +6 | sudo xargs rm -rf
            fi
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            sudo mkdir -p ${{ secrets.DEPLOY_PATH }}
            
            # æ¸…ç†æ—§æ–‡ä»¶å¹¶è§£å‹æ–°æ–‡ä»¶
            sudo rm -rf ${{ secrets.DEPLOY_PATH }}/*
            sudo tar -xzf /tmp/admin-system.tar.gz -C ${{ secrets.DEPLOY_PATH }}
            
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            sudo chown -R www-data:www-data ${{ secrets.DEPLOY_PATH }}
            sudo chmod -R 755 ${{ secrets.DEPLOY_PATH }}
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/admin-system.tar.gz
            
            echo "éƒ¨ç½²å®Œæˆï¼"
            echo "éƒ¨ç½²è·¯å¾„: ${{ secrets.DEPLOY_PATH }}"
            echo "éƒ¨ç½²æ—¶é—´: $(date)"
          EOF

      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸš€ Admin System éƒ¨ç½²æˆåŠŸ!"
          echo "ğŸ“ éƒ¨ç½²è·¯å¾„: ${{ secrets.DEPLOY_PATH }}"
          echo "ğŸŒ æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          echo "â° éƒ¨ç½²æ—¶é—´: $(date)"

  # è¿è¡Œæµ‹è¯•å’Œä»£ç æ£€æŸ¥
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ç±»å‹æ£€æŸ¥
        run: pnpm turbo type-check

      - name: ä»£ç æ£€æŸ¥
        run: pnpm turbo lint