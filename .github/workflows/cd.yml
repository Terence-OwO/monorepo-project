name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]

env:
  NODE_VERSION: "18"
  PNPM_VERSION: "9.15.1"

jobs:
  changes:
    name: æ£€æµ‹å˜æ›´
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    outputs:
      ui-components: ${{ steps.changes.outputs.ui-components }}
      admin-system: ${{ steps.changes.outputs.admin-system }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            ui-components:
              - 'packages/ui-components/**'
            admin-system:
              - 'apps/admin-system/**'
              - 'packages/ui-components/**'

  build-and-deploy-ui-components:
    name: æ„å»ºå¹¶éƒ¨ç½² UI ç»„ä»¶åº“
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.ui-components == 'true'
    environment: production
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: é…ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£…ä¾èµ–åŒ…
        run: pnpm install --frozen-lockfile

      - name: æ„å»º UI ç»„ä»¶åº“
        run: pnpm --filter @monorepo-project/ui-components build

      - name: åˆ›å»ºéƒ¨ç½²åŒ…
        run: |
          cd packages/ui-components
          tar -czf ui-components-${{ github.sha }}.tar.gz dist package.json
          mkdir -p ../../deployment-packages
          mv ui-components-${{ github.sha }}.tar.gz ../../deployment-packages/

      - name: ä¸Šä¼ éƒ¨ç½²åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: ui-components-deployment
          path: deployment-packages/ui-components-${{ github.sha }}.tar.gz
          retention-days: 30

      # å¦‚æœä½ æœ‰ç§æœ‰ npm registryï¼Œå¯ä»¥å‘å¸ƒåˆ°é‚£é‡Œ
      # - name: Publish to NPM Registry
      #   if: github.ref == 'refs/heads/main'
      #   run: |
      #     cd packages/ui-components
      #     npm config set registry ${{ secrets.NPM_REGISTRY_URL }}
      #     npm config set //your-registry.com/:_authToken ${{ secrets.NPM_TOKEN }}
      #     npm publish

  build-and-deploy-admin-system:
    name: æ„å»ºå¹¶éƒ¨ç½²åå°ç®¡ç†ç³»ç»Ÿ
    runs-on: ubuntu-latest
    needs: [changes, build-and-deploy-ui-components]
    if: always() && needs.changes.outputs.admin-system == 'true'
    environment: production
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: é…ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£…ä¾èµ–åŒ…
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºåå°ç®¡ç†ç³»ç»Ÿ
        run: pnpm --filter @monorepo-project/admin-system build
        env:
          NODE_ENV: production

      - name: åˆ›å»ºéƒ¨ç½²åŒ…
        run: |
          cd apps/admin-system
          tar -czf admin-system-${{ github.sha }}.tar.gz dist
          mkdir -p ../../deployment-packages
          mv admin-system-${{ github.sha }}.tar.gz ../../deployment-packages/

      - name: ä¸Šä¼ éƒ¨ç½²åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: admin-system-deployment
          path: deployment-packages/admin-system-${{ github.sha }}.tar.gz
          retention-days: 30

      - name: é…ç½®SSHç¯å¢ƒ
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # è®¾ç½®SSHç§é’¥
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # é…ç½®SSH config
          cat > ~/.ssh/config << EOF
          Host ${{ secrets.SERVER_HOST }}
              HostName ${{ secrets.SERVER_HOST }}
              User ${{ secrets.SERVER_USER }}
              Port ${{ secrets.SERVER_PORT || 22 }}
              IdentityFile ~/.ssh/deploy_key
              IdentitiesOnly yes
          EOF

          # æ·»åŠ æœåŠ¡å™¨ä¸»æœºå¯†é’¥åˆ° known_hosts
          if [[ -n "${{ secrets.KNOWN_HOSTS }}" ]]; then
            echo "${{ secrets.KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
            chmod 600 ~/.ssh/known_hosts
            echo "      StrictHostKeyChecking yes" >> ~/.ssh/config
          else
            # å¦‚æœæ²¡æœ‰é…ç½® KNOWN_HOSTSï¼Œåˆ™ç¦ç”¨ä¸¥æ ¼ä¸»æœºå¯†é’¥æ£€æŸ¥ï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰
            echo "      StrictHostKeyChecking no" >> ~/.ssh/config
            echo "      UserKnownHostsFile /dev/null" >> ~/.ssh/config
            echo "      LogLevel ERROR" >> ~/.ssh/config
          fi

          chmod 600 ~/.ssh/config

          # æµ‹è¯•SSHè¿æ¥
          echo "æµ‹è¯•SSHè¿æ¥..."
          ssh -o ConnectTimeout=10 ${{ secrets.SERVER_HOST }} "echo 'SSHè¿æ¥æµ‹è¯•æˆåŠŸ'"

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: admin-system-deployment
          path: ./artifacts

      - name: è§£å‹æ„å»ºäº§ç‰©
        run: |
          cd artifacts
          tar -xzf admin-system-${{ github.sha }}.tar.gz
          ls -la

      - name: ä½¿ç”¨SCPéƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deploy_script.sh << 'EOF'
          #!/bin/bash
          set -e

          TIMESTAMP="${{ github.sha }}"
          DEPLOY_PATH="/var/www/admin-system"

          echo "å¼€å§‹SCPéƒ¨ç½²æµç¨‹..."
          echo "æ—¶é—´æˆ³: $TIMESTAMP"
          echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"

          # åˆ›å»ºç‰ˆæœ¬ç›®å½•
          mkdir -p "${DEPLOY_PATH}/releases/${TIMESTAMP}"

          # ç§»åŠ¨æ–‡ä»¶åˆ°ç‰ˆæœ¬ç›®å½•
          mv ./dist/* "${DEPLOY_PATH}/releases/${TIMESTAMP}/" 2>/dev/null || true

          # åˆ›å»ºè½¯é“¾æ¥åˆ°å½“å‰ç‰ˆæœ¬
          ln -sfn "${DEPLOY_PATH}/releases/${TIMESTAMP}" "${DEPLOY_PATH}/current"

          # é‡å¯WebæœåŠ¡å™¨
          sudo systemctl reload nginx || true

          # æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
          cd "${DEPLOY_PATH}/releases"
          ls -t | tail -n +6 | xargs rm -rf 2>/dev/null || true

          echo "âœ… SCPéƒ¨ç½²å®Œæˆ"
          EOF

          chmod +x deploy_script.sh

          # åˆ›å»ºè¿œç¨‹ä¸´æ—¶ç›®å½•
          remote_temp_dir="/tmp/deploy-${{ github.sha }}"
          ssh ${{ secrets.SERVER_HOST }} "mkdir -p ${remote_temp_dir}"

          # ä¸Šä¼ æ„å»ºäº§ç‰©
          echo "ä¸Šä¼ æ„å»ºäº§ç‰©..."
          scp -r artifacts/dist ${{ secrets.SERVER_HOST }}:${remote_temp_dir}/

          # ä¸Šä¼ éƒ¨ç½²è„šæœ¬
          echo "ä¸Šä¼ éƒ¨ç½²è„šæœ¬..."
          scp deploy_script.sh ${{ secrets.SERVER_HOST }}:${remote_temp_dir}/

          # æ‰§è¡Œéƒ¨ç½²
          echo "æ‰§è¡Œè¿œç¨‹éƒ¨ç½²..."
          ssh ${{ secrets.SERVER_HOST }} "cd ${remote_temp_dir} && bash deploy_script.sh"

          # æ¸…ç†è¿œç¨‹ä¸´æ—¶æ–‡ä»¶
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          ssh ${{ secrets.SERVER_HOST }} "rm -rf ${remote_temp_dir}"

      # å¤‡ç”¨éƒ¨ç½²æ–¹å¼ï¼šä½¿ç”¨ rsync
      - name: é…ç½®SSH known_hosts (å¤‡ç”¨æ–¹æ¡ˆ)
        if: false # è®¾ç½®ä¸º true æ¥å¯ç”¨è¿™ç§éƒ¨ç½²æ–¹å¼
        run: |
          mkdir -p ~/.ssh
          if [[ -n "${{ secrets.KNOWN_HOSTS }}" ]]; then
            echo "${{ secrets.KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
            chmod 600 ~/.ssh/known_hosts
          else
            echo "StrictHostKeyChecking no" >> ~/.ssh/config
            echo "UserKnownHostsFile /dev/null" >> ~/.ssh/config
            chmod 600 ~/.ssh/config
          fi

      - name: ä½¿ç”¨ rsync éƒ¨ç½²ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        if: false # è®¾ç½®ä¸º true æ¥å¯ç”¨è¿™ç§éƒ¨ç½²æ–¹å¼
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸´æ—¶ç›®å½•
            mkdir -p /tmp/admin-system-${{ github.sha }}

      - name: é€šè¿‡ rsync åŒæ­¥æ–‡ä»¶ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        if: false # è®¾ç½®ä¸º true æ¥å¯ç”¨è¿™ç§éƒ¨ç½²æ–¹å¼
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete --rsh="ssh -o StrictHostKeyChecking=no"
          path: apps/admin-system/dist/
          remote_path: /var/www/admin-system/
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

  health-check:
    name: å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-deploy-admin-system]
    if: always() && needs.build-and-deploy-admin-system.result == 'success'
    steps:
      - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
        run: sleep 30

      - name: æ‰§è¡Œå¥åº·æ£€æŸ¥
        run: |
          # æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL || 'https://your-admin-system.com' }}/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : $response"
            exit 1
          fi

  notify:
    name: éƒ¨ç½²çŠ¶æ€é€šçŸ¥
    runs-on: ubuntu-latest
    needs:
      [
        build-and-deploy-ui-components,
        build-and-deploy-admin-system,
        health-check,
      ]
    if: always()
    steps:
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: needs.build-and-deploy-admin-system.result == 'success' && needs.health-check.result == 'success'
        run: |
          echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼"
          echo "- UI ç»„ä»¶åº“: ${{ needs.build-and-deploy-ui-components.result }}"
          echo "- åå°ç®¡ç†ç³»ç»Ÿ: ${{ needs.build-and-deploy-admin-system.result }}"
          echo "- å¥åº·æ£€æŸ¥: ${{ needs.health-check.result }}"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: needs.build-and-deploy-admin-system.result == 'failure' || needs.health-check.result == 'failure'
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "- UI ç»„ä»¶åº“: ${{ needs.build-and-deploy-ui-components.result }}"
          echo "- åå°ç®¡ç†ç³»ç»Ÿ: ${{ needs.build-and-deploy-admin-system.result }}"
          echo "- å¥åº·æ£€æŸ¥: ${{ needs.health-check.result }}"
          exit 1

      # å¯é€‰ï¼šå‘é€é€šçŸ¥åˆ° Slackã€é’‰é’‰ç­‰
      # - name: Send Slack Notification
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
